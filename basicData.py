
from WindPy import w
import datetime as dt
import pandas as pd
import re

w.start() # 默认命令超时时间为120秒，如需设置超时时间可以加入waitTime参数，例如waitTime=60,即设置命令超时时间为60秒
w.isconnected() # 判断WindPy是否已经登录成功

# 行业分类表
ind = pd.read_excel('./Data/全部A股.xlsx')
ind = ind.rename(dict(zip(ind.columns,['证券代码','证券简称','一级行业名称','二级行业名称','三级行业名称','一级行业','二级行业','三级行业'])),axis=1)
ind = ind.drop_duplicates(subset=['一级行业','二级行业','三级行业'])[ind.columns[-6:]]

ind['二级行业名称'] = ind['二级行业名称'].apply(lambda x:''.join(re.findall(r'[\u4e00-\u9fa5]',x)))
ind['三级行业名称'] = ind['三级行业名称'].apply(lambda x:''.join(re.findall(r'[\u4e00-\u9fa5]',x)))
# 二三级行业都是“证券”

ind1 = ind['一级行业名称'].drop_duplicates().tolist()
ind2 = ind['二级行业名称'].drop_duplicates().tolist()
ind3 = ind['三级行业名称'].drop_duplicates().tolist()
ind3.remove('')

# 特殊关键词手动识别
trans_dict_df = pd.read_excel('./Data/trans_dict.xlsx')
trans_dict_df['现有名称'] = trans_dict_df['现有名称'].apply(lambda x:x.split(','))
trans_dict = dict(zip(trans_dict_df['原有名称'],trans_dict_df.index))

# 申万行业
sw1 = w.wss("801010.SI,801020.SI,801030.SI,801040.SI,801050.SI,801080.SI,801110.SI,801120.SI,801130.SI,801140.SI,801150.SI,801160.SI,801170.SI,801180.SI,801200.SI,801210.SI,801230.SI,801710.SI,801720.SI,801730.SI,801740.SI,801750.SI,801760.SI,801770.SI,801780.SI,801790.SI,801880.SI,801890.SI", "trade_code,sec_name",usedf=True)[1]
sw1['SEC_NAME'] = sw1['SEC_NAME'].apply(lambda x :x[:-4])

sw2 = w.wss("801011.SI,801012.SI,801013.SI,801014.SI,801015.SI,801016.SI,801017.SI,801018.SI,801021.SI,801022.SI,801023.SI,801024.SI,801032.SI,801033.SI,801034.SI,801035.SI,801036.SI,801037.SI,801041.SI,801051.SI,801053.SI,801054.SI,801055.SI,801072.SI,801073.SI,801074.SI,801075.SI,801076.SI,801081.SI,801082.SI,801083.SI,801084.SI,801085.SI,801092.SI,801093.SI,801094.SI,801101.SI,801102.SI,801111.SI,801112.SI,801123.SI,801124.SI,801131.SI,801132.SI,801141.SI,801142.SI,801143.SI,801144.SI,801151.SI,801152.SI,801153.SI,801154.SI,801155.SI,801156.SI,801161.SI,801162.SI,801163.SI,801164.SI,801171.SI,801172.SI,801173.SI,801174.SI,801175.SI,801176.SI,801177.SI,801178.SI,801181.SI,801182.SI,801191.SI,801192.SI,801193.SI,801194.SI,801202.SI,801203.SI,801204.SI,801205.SI,801211.SI,801212.SI,801213.SI,801214.SI,801215.SI,801222.SI,801223.SI,801231.SI,801711.SI,801712.SI,801713.SI,801721.SI,801722.SI,801723.SI,801724.SI,801725.SI,801731.SI,801732.SI,801733.SI,801734.SI,801741.SI,801742.SI,801743.SI,801744.SI,801751.SI,801752.SI,801761.SI,801881.SI", "trade_code,sec_name",usedf=True)[1]
sw2['SEC_NAME'] = sw2['SEC_NAME'].apply(lambda x:x[:-4])
sw2['SEC_NAME'] = sw2['SEC_NAME'].apply(lambda x:''.join(re.findall(r'[\u4e00-\u9fa5]',x)))
sw2.loc['801193.SI','SEC_NAME'] ='证券'

sw3 = w.wss("850111.SI,850112.SI,850113.SI,850121.SI,850122.SI,850131.SI,850141.SI,850151.SI,850152.SI,850154.SI,850161.SI,850171.SI,850181.SI,850211.SI,850221.SI,850222.SI,850231.SI,850241.SI,850242.SI,850311.SI,850313.SI,850321.SI,850322.SI,850323.SI,850324.SI,850331.SI,850332.SI,850333.SI,850334.SI,850335.SI,850336.SI,850337.SI,850338.SI,850339.SI,850341.SI,850342.SI,850343.SI,850344.SI,850345.SI,850351.SI,850352.SI,850353.SI,850361.SI,850362.SI,850363.SI,850372.SI,850373.SI,850381.SI,850382.SI,850383.SI,850411.SI,850412.SI,850521.SI,850522.SI,850523.SI,850531.SI,850541.SI,850542.SI,850543.SI,850544.SI,850551.SI,850552.SI,850553.SI,850611.SI,850612.SI,850614.SI,850615.SI,850616.SI,850623.SI,850711.SI,850712.SI,850713.SI,850714.SI,850715.SI,850716.SI,850721.SI,850722.SI,850723.SI,850724.SI,850725.SI,850726.SI,850727.SI,850728.SI,850729.SI,850731.SI,850741.SI,850751.SI,850811.SI,850812.SI,850813.SI,850822.SI,850823.SI,850831.SI,850832.SI,850833.SI,850841.SI,850851.SI,850852.SI,850911.SI,850912.SI,850913.SI,850921.SI,850935.SI,850936.SI,850941.SI,851012.SI,851013.SI,851014.SI,851021.SI,851111.SI,851112.SI,851113.SI,851114.SI,851115.SI,851121.SI,851122.SI,851231.SI,851232.SI,851233.SI,851234.SI,851235.SI,851236.SI,851241.SI,851242.SI,851243.SI,851244.SI,851311.SI,851312.SI,851313.SI,851314.SI,851315.SI,851316.SI,851322.SI,851323.SI,851324.SI,851325.SI,851326.SI,851327.SI,851411.SI,851421.SI,851432.SI,851433.SI,851434.SI,851435.SI,851441.SI,851511.SI,851512.SI,851521.SI,851531.SI,851541.SI,851551.SI,851561.SI,851611.SI,851612.SI,851613.SI,851614.SI,851615.SI,851621.SI,851631.SI,851641.SI,851711.SI,851721.SI,851731.SI,851741.SI,851751.SI,851761.SI,851771.SI,851781.SI,851811.SI,851821.SI,851911.SI,851921.SI,851931.SI,851941.SI,852021.SI,852031.SI,852032.SI,852033.SI,852041.SI,852051.SI,852052.SI,852111.SI,852112.SI,852121.SI,852131.SI,852141.SI,852151.SI,852211.SI,852221.SI,852222.SI,852223.SI,852224.SI,852225.SI,852226.SI,852241.SI,852242.SI,852243.SI,852244.SI,852311.SI,857221.SI,857231.SI,857232.SI,857233.SI,857234.SI,857235.SI,857241.SI,857242.SI,857243.SI,857244.SI,857251.SI,857321.SI,857322.SI,857323.SI,857331.SI,857332.SI,857333.SI,857334.SI,857335.SI,857336.SI,857341.SI,857342.SI,857343.SI,857344.SI,857411.SI,857421.SI,857431.SI,858811.SI", "trade_code,sec_name",usedf=True)[1]
sw3['SEC_NAME'] = sw3['SEC_NAME'].apply(lambda x:x[:-4])
sw3['SEC_NAME'] = sw3['SEC_NAME'].apply(lambda x:''.join(re.findall(r'[\u4e00-\u9fa5]',x)))

inddata = w.wsd(','.join(sw1.index)+','+','.join(sw2.index)+','+','.join(sw3.index), "pct_chg", "2013-09-01", "", "PriceAdj=F",usedf=True)[1] #Days=Alldays;
benchmark= w.wsd('000905.SH', "pct_chg", "2013-09-01", "", "PriceAdj=F",usedf=True)[1]

TRADING_DAY = w.tdays("2013-01-01", "",usedf=True)[1]
ONE_DAY = dt.timedelta(days=1)
TRADING_DAY.columns=['date']
TRADING_DAY.index = TRADING_DAY['date']

today = dt.date.today()
today = str(today).replace('-', '')